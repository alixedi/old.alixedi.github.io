<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Introducing Django Sieve</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="So I was feeling nostalgic...">
    <link rel="canonical" href="http://alixedi.github.io/2014/06/05/introducing-django-sieve/">
    <link href='http://fonts.googleapis.com/css?family=Anonymous+Pro:700' rel='stylesheet' type='text/css'>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/pygments.css">
</head>


    <body>

      <div class="container">

        <h1 class="header" style="text-decoration: none; text-transform: lowercase;">
  <a style="color: #000;" href="/">Typewriter</a>
</h1>

<p class="sub">
  So I was feeling nostalgic...
</p>

<div class="menu">
  <ul class="navlist">
    
    <li>
      <a class="page-link" href="/about">About</a>
    </li>
    
    <li>
      <a class="page-link" href="http://twitter.com/alixedi">Twitter</a>
    </li>
    
    <li>
      <a class="page-link" href="http://github.com/alixedi">Github</a>
    </li>
    
    <li>
      <a class="page-link" href="/feed.xml">RSS</a>
    </li>
    
  </ul>
</div>


        <div class="post">

  <header class="post-header">
    <h1>Introducing Django Sieve</h1>
  </header>

  <article class="post-content">
  <p>So we were developing a CRM-like system over at Bitswits. The users of the system were sales representatives of a telco. Without getting bogged down by the details, we were required to do the following from an access control perspective:</p>

<ol>
  <li>
    <p>Each sales rep will be assigned a set of companies.</p>
  </li>
  <li>
    <p>Each sales rep will be assigned a single country.</p>
  </li>
  <li>
    <p>The sales rep will be able to access data from his assigned set of companies and the country <em>only</em>.</p>
  </li>
</ol>

<p>These cute little features morphed into a monster because of the following scenario:</p>

<p>So lets do a little operator overloading - if “&gt;” signifies a foreign-key relation from the left-side operand to the right-side operand, we were dealing with situations such as:</p>

<pre><code>Rate &gt; Tariff &gt; Vendor &gt; Company
</code></pre>

<p>Also, some of the relations were ManyToMany - if “»” signifies a ManyToMany relation from the left-side operand to the right-side operand:</p>

<pre><code>Rate &gt; Tariff &gt;&gt; Client(s) &gt; Comapny
</code></pre>

<p>Finally, consider the fact that the system had 100-odd views and we had a show-stopper. There was no way I could allow my precious Python devs to spend a couple of weeks writing and tuning queries by hand for what seemes like at least a couple of weeks.</p>

<p>Enter Sieve. Following is whole code that solved the problem.</p>

<p>Create the control model - the one that stores which sales rep has access to which companies and country:</p>

<div class="highlight"><pre><code class="python"><span class="k">class</span> <span class="nc">Sieve</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="n">auth</span><span class="o">.</span><span class="n">Group</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">companies</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="n">Company</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">country</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Country</span><span class="p">)</span></code></pre></div>

<p>Identify the sieve model in your settings.py:</p>

<pre><code>SIEVE_MODEL = ''crm.Sieve''
</code></pre>

<p>Over-ride the ModelManagers for the models that you want filtered:</p>

<pre><code>class Country(models.Model):
        name = models.CharField(max_length=30)
        dialcode = models.DialcodeField()
        objects = SieveManager()
</code></pre>

<p>Rock-on like so:</p>

<pre><code>class CoutryView(ListView):
    objects = Country.objects.sieve(user=request.user)
</code></pre>

<p>That is all. Site-wide filtering of user data based on predefined criteria without having to write queries for all the views.</p>

  </article>

  <p class="meta">Jun 5, 2014</p>
</div>


        <footer class="site-footer">

  My take on Typewriter - @alixedi

</footer>


      </div>

    </body>
</html>
